<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agentic Video Question Generator</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .upload-area {
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .upload-area:hover {
            border-color: #007bff;
            background-color: #f8f9fa;
        }
        .upload-area.dragover {
            border-color: #28a745;
            background-color: #d4edda;
        }
        .progress {
            display: none;
            margin-top: 20px;
        }
        .agent-pipeline {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            border-radius: 15px;
            margin: 2rem 0;
        }
        .agent-step {
            background: rgba(255,255,255,0.1);
            padding: 1rem;
            border-radius: 10px;
            margin: 0.5rem 0;
        }
        .status-message {
            display: none;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container py-5">
        <!-- Header -->
        <div class="text-center mb-5">
            <h1 class="display-4"><i class="fas fa-robot text-primary"></i> Agentic Video Question Generator</h1>
            <p class="lead">Transform your educational videos into validated questions using AI agents</p>
        </div>

        <!-- Pipeline Overview -->
        <div class="agent-pipeline">
            <h3 class="text-center mb-4"><i class="fas fa-cogs"></i> Enhanced AI Pipeline</h3>
            <div class="row">
                <div class="col-md-3">
                    <div class="agent-step">
                        <h5><i class="fas fa-film"></i> Agent 1</h5>
                        <p>Frame Analyzer<br><small>VLM extracts visual content</small></p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="agent-step">
                        <h5><i class="fas fa-eye"></i> Agent 2</h5>
                        <p>Content Validator<br><small>Validates frame-transcript alignment</small></p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="agent-step">
                        <h5><i class="fas fa-question"></i> Agent 3</h5>
                        <p>Question Generator<br><small>Creates MCQ/MSQ/NAT questions</small></p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="agent-step">
                        <h5><i class="fas fa-chart-line"></i> Agent 4</h5>
                        <p>LLM Judge<br><small>Quality scoring & tagging</small></p>
                    </div>
                </div>
            </div>
            <div class="text-center mt-3">
                <p class="text-muted">
                    <i class="fas fa-magic"></i> <strong>New:</strong> Frame-by-frame analysis ensures questions align with actual video content!
                </p>
            </div>
        </div>

        <!-- Upload Form -->
        <div class="row">
            <div class="col-lg-8 mx-auto">
                <div class="card shadow">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0"><i class="fas fa-upload"></i> Upload Files</h4>
                    </div>
                    <div class="card-body">
                        <form id="uploadForm" enctype="multipart/form-data">
                            <!-- Video Upload -->
                            <div class="mb-4">
                                <label class="form-label"><i class="fas fa-video text-danger"></i> Video File</label>
                                <div class="upload-area" id="videoUploadArea">
                                    <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                                    <p>Drag & drop your video file here or click to browse</p>
                                    <p><small class="text-muted">Supported formats: MP4, AVI, MOV, MKV, WMV (Max 500MB)</small></p>
                                    <input type="file" id="videoFile" name="video" accept=".mp4,.avi,.mov,.mkv,.wmv" class="d-none">
                                </div>
                                <div id="videoInfo" class="mt-2"></div>
                            </div>

                            <!-- Transcript Upload -->
                            <div class="mb-4">
                                <label class="form-label"><i class="fas fa-file-alt text-success"></i> Transcript File (Optional)</label>
                                <div class="upload-area" id="transcriptUploadArea">
                                    <i class="fas fa-file-upload fa-3x text-muted mb-3"></i>
                                    <p>Drag & drop your transcript file here or click to browse</p>
                                    <p><small class="text-muted">Supported formats: JSON, SRT, VTT, TXT</small></p>
                                    <input type="file" id="transcriptFile" name="transcript" accept=".json,.srt,.vtt,.txt" class="d-none">
                                </div>
                                <div id="transcriptInfo" class="mt-2"></div>
                                
                                <!-- Transcript Generation Options -->
                                <div class="mt-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="generateTranscript">
                                        <label class="form-check-label" for="generateTranscript">
                                            <i class="fas fa-magic text-primary"></i> Generate transcript automatically
                                        </label>
                                    </div>
                                    
                                    <div id="transcriptOptions" class="mt-3" style="display: none;">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <label class="form-label">Transcription Method</label>
                                                <select class="form-select" id="transcriptMethod">
                                                    <option value="whisper">Whisper (High Accuracy)</option>
                                                    <option value="speech_recognition">Google Speech (Faster)</option>
                                                </select>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Output Format</label>
                                                <select class="form-select" id="outputFormat">
                                                    <option value="vtt">VTT (WebVTT)</option>
                                                    <option value="srt">SRT (SubRip)</option>
                                                    <option value="json">JSON (Structured)</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Processing Options -->
                            <div class="mb-4">
                                <h5><i class="fas fa-cog"></i> Processing Options</h5>
                                <div class="row">
                                    <div class="col-md-6">
                                        <label class="form-label">Number of Questions</label>
                                        <input type="number" class="form-control" id="numQuestions" value="5" min="1" max="150">
                                        <small class="form-text text-muted">LLM Judge will automatically determine question difficulty and quality</small>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Analysis Method</label>
                                        <select class="form-control" id="analysisMode">
                                            <option value="strategic_hybrid" selected>ÔøΩ Strategic Hybrid (Easy/Medium/Hard per timestamp) - Recommended</option>
                                            <option value="frame_based">ÔøΩüé¨ Frame-by-Frame VLM Only</option>
                                            <option value="hybrid">üîÑ Hybrid (Frame + Transcript)</option>
                                            <option value="timestamp_based">üìù Traditional Timestamp-based</option>
                                        </select>
                                        <small class="form-text text-muted"><strong>Strategic Hybrid:</strong> Generates 3 difficulty levels (Easy/Medium/Hard) for each validated educational moment using both visual and transcript analysis</small>
                                    </div>
                                </div>
                                <div class="row mt-3">
                                    <div class="col-md-12">
                                        <label class="form-label">Additional Options</label>
                                        <div class="form-check mt-2">
                                            <input class="form-check-input" type="checkbox" id="useVLM" checked>
                                            <label class="form-check-label" for="useVLM">
                                                <i class="fas fa-eye text-primary"></i> Enhanced MCQ/MSQ/NAT Question Types
                                            </label>
                                            <small class="form-text text-muted">Generates multiple choice, multi-select, and numerical answer questions</small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Progress Bar -->
                            <div class="progress" id="uploadProgress">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar"></div>
                            </div>

                            <!-- Status Messages -->
                            <div id="statusMessage" class="status-message"></div>

                            <!-- Submit Button -->
                            <div class="d-grid">
                                <button type="submit" id="generateBtn" class="btn btn-primary btn-lg" disabled>
                                    <i class="fas fa-magic"></i> Generate Questions
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div id="resultsSection" class="mt-5" style="display: none;">
            <div class="card shadow">
                <div class="card-header bg-success text-white">
                    <h4 class="mb-0"><i class="fas fa-check-circle"></i> Generated Questions</h4>
                </div>
                <div class="card-body">
                    <div id="questionStats" class="row mb-4"></div>
                    <div id="questionsList"></div>
                    <div class="text-center mt-4">
                        <button id="downloadBtn" class="btn btn-outline-success">
                            <i class="fas fa-download"></i> Download Questions (JSON)
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let uploadedFiles = {};

        // File upload handling
        document.getElementById('videoUploadArea').addEventListener('click', () => {
            document.getElementById('videoFile').click();
        });

        document.getElementById('transcriptUploadArea').addEventListener('click', () => {
            document.getElementById('transcriptFile').click();
        });

        // Drag and drop
        ['videoUploadArea', 'transcriptUploadArea'].forEach(areaId => {
            const area = document.getElementById(areaId);
            
            area.addEventListener('dragover', (e) => {
                e.preventDefault();
                area.classList.add('dragover');
            });
            
            area.addEventListener('dragleave', () => {
                area.classList.remove('dragover');
            });
            
            area.addEventListener('drop', (e) => {
                e.preventDefault();
                area.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    const inputId = areaId === 'videoUploadArea' ? 'videoFile' : 'transcriptFile';
                    document.getElementById(inputId).files = files;
                    handleFileSelect(inputId);
                }
            });
        });

        // File selection handlers
        document.getElementById('videoFile').addEventListener('change', () => handleFileSelect('videoFile'));
        document.getElementById('transcriptFile').addEventListener('change', () => handleFileSelect('transcriptFile'));

        function handleFileSelect(inputId) {
            const input = document.getElementById(inputId);
            const file = input.files[0];
            
            if (file) {
                const infoId = inputId === 'videoFile' ? 'videoInfo' : 'transcriptInfo';
                const infoDiv = document.getElementById(infoId);
                
                infoDiv.innerHTML = `
                    <div class="alert alert-info">
                        <i class="fas fa-file"></i> <strong>${file.name}</strong> 
                        <small>(${(file.size / 1024 / 1024).toFixed(1)} MB)</small>
                    </div>
                `;
                
                uploadedFiles[inputId] = file;
                checkFormReady();
            }
        }

        function checkFormReady() {
            const generateBtn = document.getElementById('generateBtn');
            const hasVideo = uploadedFiles['videoFile'];
            const hasTranscript = uploadedFiles['transcriptFile'];
            const generateTranscript = document.getElementById('generateTranscript').checked;
            
            if (hasVideo && (hasTranscript || generateTranscript)) {
                generateBtn.disabled = false;
                generateBtn.innerHTML = '<i class="fas fa-magic"></i> Generate Questions';
            } else {
                generateBtn.disabled = true;
                if (!hasVideo) {
                    generateBtn.innerHTML = '<i class="fas fa-upload"></i> Upload Video First';
                } else {
                    generateBtn.innerHTML = '<i class="fas fa-file-alt"></i> Add Transcript or Enable Auto-Generation';
                }
            }
        }

        // Handle transcript generation checkbox
        document.getElementById('generateTranscript').addEventListener('change', function() {
            const transcriptOptions = document.getElementById('transcriptOptions');
            const transcriptUploadArea = document.getElementById('transcriptUploadArea');
            
            if (this.checked) {
                transcriptOptions.style.display = 'block';
                transcriptUploadArea.style.opacity = '0.5';
                transcriptUploadArea.style.pointerEvents = 'none';
            } else {
                transcriptOptions.style.display = 'none';
                transcriptUploadArea.style.opacity = '1';
                transcriptUploadArea.style.pointerEvents = 'auto';
            }
            
            checkFormReady();
        });

        // Form submission
        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const generateBtn = document.getElementById('generateBtn');
            const statusMessage = document.getElementById('statusMessage');
            const progressBar = document.getElementById('uploadProgress');
            
            // Show progress
            generateBtn.disabled = true;
            generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
            progressBar.style.display = 'block';
            
            try {
                // Upload files
                statusMessage.innerHTML = '<div class="alert alert-info"><i class="fas fa-upload"></i> Uploading files...</div>';
                statusMessage.style.display = 'block';
                
                const formData = new FormData();
                formData.append('video', uploadedFiles['videoFile']);
                
                // Only add transcript if uploaded and not generating
                const generateTranscript = document.getElementById('generateTranscript').checked;
                if (!generateTranscript && uploadedFiles['transcriptFile']) {
                    formData.append('transcript', uploadedFiles['transcriptFile']);
                }
                
                const uploadResponse = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });
                
                if (!uploadResponse.ok) {
                    throw new Error('Upload failed');
                }
                
                const uploadResult = await uploadResponse.json();
                
                // Process files
                if (generateTranscript) {
                    statusMessage.innerHTML = '<div class="alert alert-warning"><i class="fas fa-microphone fa-spin"></i> Generating transcript...</div>';
                } else {
                    statusMessage.innerHTML = '<div class="alert alert-warning"><i class="fas fa-cogs fa-spin"></i> Analyzing video and generating questions...</div>';
                }
                
                // Prepare processing parameters
                const processParams = {
                    video_file: uploadResult.video_file,
                    transcript_file: uploadResult.transcript_file,
                    generate_transcript: generateTranscript,
                    num_questions: parseInt(document.getElementById('numQuestions').value),
                    use_vlm: document.getElementById('useVLM').checked,
                    analysis_mode: document.getElementById('analysisMode').value,
                    include_mcq: document.getElementById('useVLM').checked  // Enhanced question types
                };
                
                if (generateTranscript) {
                    processParams.transcript_method = document.getElementById('transcriptMethod').value;
                    processParams.output_format = document.getElementById('outputFormat').value;
                }
                
                const processResponse = await fetch('/process', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(processParams)
                });
                
                if (!processResponse.ok) {
                    throw new Error('Processing failed');
                }
                
                const result = await processResponse.json();
                
                // Show results
                displayResults(result);
                let successMessage = '<div class="alert alert-success"><i class="fas fa-check"></i> Questions generated successfully!';
                if (result.transcript_generated) {
                    successMessage += ' Transcript was auto-generated.';
                }
                successMessage += '</div>';
                statusMessage.innerHTML = successMessage;
                
            } catch (error) {
                console.error('Error:', error);
                statusMessage.innerHTML = `<div class="alert alert-danger"><i class="fas fa-exclamation-triangle"></i> Error: ${error.message}</div>`;
            } finally {
                progressBar.style.display = 'none';
                generateBtn.disabled = false;
                generateBtn.innerHTML = '<i class="fas fa-magic"></i> Generate Questions';
            }
        });

        function displayResults(result) {
            const resultsSection = document.getElementById('resultsSection');
            const questionStats = document.getElementById('questionStats');
            const questionsList = document.getElementById('questionsList');
            
            // Show results section
            resultsSection.style.display = 'block';
            
            // Display statistics
            const stats = analyzeQuestions(result.questions);
            questionStats.innerHTML = `
                <div class="col-md-3">
                    <div class="text-center">
                        <h3 class="text-primary">${result.total_questions}</h3>
                        <p>Total Questions</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="text-center">
                        <h3 class="text-success">${stats.easy}</h3>
                        <p>Easy</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="text-center">
                        <h3 class="text-warning">${stats.medium}</h3>
                        <p>Medium</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="text-center">
                        <h3 class="text-danger">${stats.hard}</h3>
                        <p>Hard</p>
                    </div>
                </div>
            `;
            
            // Display questions
            let questionsHtml = '';
            result.questions.forEach((q, index) => {
                const difficultyClass = {
                    'easy': 'success',
                    'medium': 'warning', 
                    'hard': 'danger'
                }[q.question.difficulty] || 'secondary';
                
                questionsHtml += `
                    <div class="card mb-3">
                        <div class="card-header d-flex justify-content-between">
                            <span><strong>Question ${index + 1}</strong> - ${q.timestamp}</span>
                            <span class="badge bg-${difficultyClass}">${q.question.difficulty}</span>
                        </div>
                        <div class="card-body">
                            <h6 class="text-primary">${q.question.text}</h6>
                            <p><strong>Answer:</strong> ${q.question.answer}</p>
                            <p><strong>Type:</strong> ${q.question.type}</p>
                        </div>
                    </div>
                `;
            });
            
            questionsList.innerHTML = questionsHtml;
            
            // Setup download
            document.getElementById('downloadBtn').onclick = () => {
                downloadQuestions(result.questions, result.output_file);
            };
            
            // Scroll to results
            resultsSection.scrollIntoView({ behavior: 'smooth' });
        }

        function analyzeQuestions(questions) {
            const stats = { easy: 0, medium: 0, hard: 0 };
            questions.forEach(q => {
                const difficulty = q.question.difficulty || 'medium';
                stats[difficulty] = (stats[difficulty] || 0) + 1;
            });
            return stats;
        }

        function downloadQuestions(questions, filename) {
            const dataStr = JSON.stringify(questions, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = filename || 'questions.json';
            link.click();
        }
    </script>
</body>
</html>
